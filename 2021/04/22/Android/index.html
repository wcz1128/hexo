<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Android 一些记录 | 随手笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="简介  Android 一些简单记录">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 一些记录">
<meta property="og:url" content="http://example.com/2021/04/22/Android/index.html">
<meta property="og:site_name" content="随手笔记">
<meta property="og:description" content="简介  Android 一些简单记录">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-22T05:37:35.000Z">
<meta property="article:modified_time" content="2021-05-31T01:51:14.837Z">
<meta property="article:author" content="王承志">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="随手笔记" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<script>
	var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cfec4a6dbde57401cf5e2f78fa73bf34";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">随手笔记</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Android" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/22/Android/" class="article-date">
  <time datetime="2021-04-22T05:37:35.000Z" itemprop="datePublished">2021-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android 一些记录
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>  Android 一些简单记录</p>
<span id="more"></span>

<h1 id="vpn"><a href="#vpn" class="headerlink" title="vpn"></a>vpn</h1><p>     受保护的socket会最终通过<code>setsockopt(*socketFd, SOL_SOCKET, SO_MARK,...)</code>设置标志位，并且这个标志位并不在数据包内，而是内核的一个标志。</p>
<p>frameworks/base/core/java/android/net/VpnService.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Protect a socket from VPN connections. After protecting, data sent</span><br><span class="line"> * through this socket will go directly to the underlying network,</span><br><span class="line"> * so its traffic will not be forwarded through the VPN.</span><br><span class="line"> * This method is useful if some connections need to be kept</span><br><span class="line"> * outside of VPN. For example, a VPN tunnel should protect itself if its</span><br><span class="line"> * destination is covered by VPN routes. Otherwise its outgoing packets</span><br><span class="line"> * will be sent back to the VPN interface and cause an infinite loop. This</span><br><span class="line"> * method will fail if the application is not prepared or is revoked.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p class&#x3D;&quot;note&quot;&gt;The socket is NOT closed by this method.</span><br><span class="line"> *</span><br><span class="line"> * @return &#123;@code true&#125; on success.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public boolean protect(int socket) &#123;</span><br><span class="line">    return NetworkUtils.protectFromVpn(socket);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Convenience method to protect a &#123;@link Socket&#125; from VPN connections.</span><br><span class="line"> *</span><br><span class="line"> * @return &#123;@code true&#125; on success.</span><br><span class="line"> * @see #protect(int)</span><br><span class="line"> *&#x2F;</span><br><span class="line">public boolean protect(Socket socket) &#123;</span><br><span class="line">    return protect(socket.getFileDescriptor$().getInt$());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>frameworks/base/core/java/android/net/NetworkUtils.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Protect &#123;@code fd&#125; from VPN connections.  After protecting, data sent through</span><br><span class="line"> * this socket will go directly to the underlying network, so its traffic will not be</span><br><span class="line"> * forwarded through the VPN.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static boolean protectFromVpn(FileDescriptor fd) &#123;</span><br><span class="line">    return protectFromVpn(fd.getInt$());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Protect &#123;@code socketfd&#125; from VPN connections.  After protecting, data sent through</span><br><span class="line"> * this socket will go directly to the underlying network, so its traffic will not be</span><br><span class="line"> * forwarded through the VPN.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public native static boolean protectFromVpn(int socketfd);</span><br></pre></td></tr></table></figure>

<p>frameworks/base/core/jni/android_net_NetUtils.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;protectFromVpn&quot;, &quot;(I)Z&quot;, (void*)android_net_utils_protectFromVpn &#125;,</span><br><span class="line">static jboolean android_net_utils_protectFromVpn(JNIEnv *env, jobject thiz, jint socket)</span><br><span class="line">&#123;</span><br><span class="line">    return (jboolean) !protectFromVpn(socket);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>system/netd/client/NetdClient.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">extern &quot;C&quot; int protectFromVpn(int socketFd) &#123;</span><br><span class="line">    if (socketFd &lt; 0) &#123;</span><br><span class="line">        return -EBADF;</span><br><span class="line">    &#125;</span><br><span class="line">    FwmarkCommand command &#x3D; &#123;FwmarkCommand::PROTECT_FROM_VPN, 0, 0&#125;;</span><br><span class="line">    return FwmarkClient().send(&amp;command, socketFd, nullptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>system/netd/server/FwmarkServer.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">int FwmarkServer::processClient(SocketClient* client, int* socketFd) &#123;</span><br><span class="line">    FwmarkCommand command;</span><br><span class="line">    FwmarkConnectInfo connectInfo;</span><br><span class="line"></span><br><span class="line">    iovec iov[2] &#x3D; &#123;</span><br><span class="line">        &#123; &amp;command, sizeof(command) &#125;,</span><br><span class="line">        &#123; &amp;connectInfo, sizeof(connectInfo) &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    msghdr message;</span><br><span class="line">    memset(&amp;message, 0, sizeof(message));</span><br><span class="line">    message.msg_iov &#x3D; iov;</span><br><span class="line">    message.msg_iovlen &#x3D; ARRAY_SIZE(iov);</span><br><span class="line"></span><br><span class="line">    union &#123;</span><br><span class="line">        cmsghdr cmh;</span><br><span class="line">        char cmsg[CMSG_SPACE(sizeof(*socketFd))];</span><br><span class="line">    &#125; cmsgu;</span><br><span class="line"></span><br><span class="line">    memset(cmsgu.cmsg, 0, sizeof(cmsgu.cmsg));</span><br><span class="line">    message.msg_control &#x3D; cmsgu.cmsg;</span><br><span class="line">    message.msg_controllen &#x3D; sizeof(cmsgu.cmsg);</span><br><span class="line"></span><br><span class="line">    int messageLength &#x3D; TEMP_FAILURE_RETRY(recvmsg(client-&gt;getSocket(), &amp;message, 0));</span><br><span class="line">    if (messageLength &lt;&#x3D; 0) &#123;</span><br><span class="line">        return -errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!((command.cmdId !&#x3D; FwmarkCommand::ON_CONNECT_COMPLETE &amp;&amp; messageLength &#x3D;&#x3D; sizeof(command))</span><br><span class="line">            || (command.cmdId &#x3D;&#x3D; FwmarkCommand::ON_CONNECT_COMPLETE</span><br><span class="line">            &amp;&amp; messageLength &#x3D;&#x3D; sizeof(command) + sizeof(connectInfo)))) &#123;</span><br><span class="line">        return -EBADMSG;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Permission permission &#x3D; mNetworkController-&gt;getPermissionForUser(client-&gt;getUid());</span><br><span class="line"></span><br><span class="line">    if (command.cmdId &#x3D;&#x3D; FwmarkCommand::QUERY_USER_ACCESS) &#123;</span><br><span class="line">        if ((permission &amp; PERMISSION_SYSTEM) !&#x3D; PERMISSION_SYSTEM) &#123;</span><br><span class="line">            return -EPERM;</span><br><span class="line">        &#125;</span><br><span class="line">        return mNetworkController-&gt;checkUserNetworkAccess(command.uid, command.netId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cmsghdr* const cmsgh &#x3D; CMSG_FIRSTHDR(&amp;message);</span><br><span class="line">    if (cmsgh &amp;&amp; cmsgh-&gt;cmsg_level &#x3D;&#x3D; SOL_SOCKET &amp;&amp; cmsgh-&gt;cmsg_type &#x3D;&#x3D; SCM_RIGHTS &amp;&amp;</span><br><span class="line">        cmsgh-&gt;cmsg_len &#x3D;&#x3D; CMSG_LEN(sizeof(*socketFd))) &#123;</span><br><span class="line">        memcpy(socketFd, CMSG_DATA(cmsgh), sizeof(*socketFd));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (*socketFd &lt; 0) &#123;</span><br><span class="line">        return -EBADF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Fwmark fwmark;</span><br><span class="line">    socklen_t fwmarkLen &#x3D; sizeof(fwmark.intValue);</span><br><span class="line">    if (getsockopt(*socketFd, SOL_SOCKET, SO_MARK, &amp;fwmark.intValue, &amp;fwmarkLen) &#x3D;&#x3D; -1) &#123;</span><br><span class="line">        return -errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch (command.cmdId) &#123;</span><br><span class="line">        case FwmarkCommand::ON_ACCEPT: &#123;</span><br><span class="line">            &#x2F;&#x2F; Called after a socket accept(). The kernel would&#39;ve marked the NetId and necessary</span><br><span class="line">            &#x2F;&#x2F; permissions bits, so we just add the rest of the user&#39;s permissions here.</span><br><span class="line">            permission &#x3D; static_cast&lt;Permission&gt;(permission | fwmark.permission);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        case FwmarkCommand::ON_CONNECT: &#123;</span><br><span class="line">            &#x2F;&#x2F; Called before a socket connect() happens. Set an appropriate NetId into the fwmark so</span><br><span class="line">            &#x2F;&#x2F; that the socket routes consistently over that network. Do this even if the socket</span><br><span class="line">            &#x2F;&#x2F; already has a NetId, so that calling connect() multiple times still works.</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; But if the explicit bit was set, the existing NetId was explicitly preferred (and not</span><br><span class="line">            &#x2F;&#x2F; a case of connect() being called multiple times). Don&#39;t reset the NetId in that case.</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; An &quot;appropriate&quot; NetId is the NetId of a bypassable VPN that applies to the user, or</span><br><span class="line">            &#x2F;&#x2F; failing that, the default network. We&#39;ll never set the NetId of a secure VPN here.</span><br><span class="line">            &#x2F;&#x2F; See the comments in the implementation of getNetworkForConnect() for more details.</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; If the protect bit is set, this could be either a system proxy (e.g.: the dns proxy</span><br><span class="line">            &#x2F;&#x2F; or the download manager) acting on behalf of another user, or a VPN provider. If it&#39;s</span><br><span class="line">            &#x2F;&#x2F; a proxy, we shouldn&#39;t reset the NetId. If it&#39;s a VPN provider, we should set the</span><br><span class="line">            &#x2F;&#x2F; default network&#39;s NetId.</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; There&#39;s no easy way to tell the difference between a proxy and a VPN app. We can&#39;t</span><br><span class="line">            &#x2F;&#x2F; use PERMISSION_SYSTEM to identify the proxy because a VPN app may also have those</span><br><span class="line">            &#x2F;&#x2F; permissions. So we use the following heuristic:</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; If it&#39;s a proxy, but the existing NetId is not a VPN, that means the user (that the</span><br><span class="line">            &#x2F;&#x2F; proxy is acting on behalf of) is not subject to a VPN, so the proxy must have picked</span><br><span class="line">            &#x2F;&#x2F; the default network&#39;s NetId. So, it&#39;s okay to replace that with the current default</span><br><span class="line">            &#x2F;&#x2F; network&#39;s NetId (which in all likelihood is the same).</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; Conversely, if it&#39;s a VPN provider, the existing NetId cannot be a VPN. The only time</span><br><span class="line">            &#x2F;&#x2F; we set a VPN&#39;s NetId into a socket without setting the explicit bit is here, in</span><br><span class="line">            &#x2F;&#x2F; ON_CONNECT, but we won&#39;t do that if the socket has the protect bit set. If the VPN</span><br><span class="line">            &#x2F;&#x2F; provider connect()ed (and got the VPN NetId set) and then called protect(), we</span><br><span class="line">            &#x2F;&#x2F; would&#39;ve unset the NetId in PROTECT_FROM_VPN below.</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; So, overall (when the explicit bit is not set but the protect bit is set), if the</span><br><span class="line">            &#x2F;&#x2F; existing NetId is a VPN, don&#39;t reset it. Else, set the default network&#39;s NetId.</span><br><span class="line">            if (!fwmark.explicitlySelected) &#123;</span><br><span class="line">                if (!fwmark.protectedFromVpn) &#123;</span><br><span class="line">                    fwmark.netId &#x3D; mNetworkController-&gt;getNetworkForConnect(client-&gt;getUid());</span><br><span class="line">                &#125; else if (!mNetworkController-&gt;isVirtualNetwork(fwmark.netId)) &#123;</span><br><span class="line">                    fwmark.netId &#x3D; mNetworkController-&gt;getDefaultNetwork();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        case FwmarkCommand::ON_CONNECT_COMPLETE: &#123;</span><br><span class="line">            &#x2F;&#x2F; Called after a socket connect() completes.</span><br><span class="line">            &#x2F;&#x2F; This reports connect event including netId, destination IP address, destination port,</span><br><span class="line">            &#x2F;&#x2F; uid, connect latency, and connect errno if any.</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; Skip reporting if connect() happened on a UDP socket.</span><br><span class="line">            int socketProto;</span><br><span class="line">            socklen_t intSize &#x3D; sizeof(socketProto);</span><br><span class="line">            const int ret &#x3D; getsockopt(*socketFd, SOL_SOCKET, SO_PROTOCOL, &amp;socketProto, &amp;intSize);</span><br><span class="line">            if ((ret !&#x3D; 0) || (socketProto &#x3D;&#x3D; IPPROTO_UDP)) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            android::sp&lt;android::net::metrics::INetdEventListener&gt; netdEventListener &#x3D;</span><br><span class="line">                    mEventReporter-&gt;getNetdEventListener();</span><br><span class="line"></span><br><span class="line">            if (netdEventListener !&#x3D; nullptr) &#123;</span><br><span class="line">                char addrstr[INET6_ADDRSTRLEN];</span><br><span class="line">                char portstr[sizeof(&quot;65536&quot;)];</span><br><span class="line">                const int ret &#x3D; getnameinfo((sockaddr*) &amp;connectInfo.addr, sizeof(connectInfo.addr),</span><br><span class="line">                        addrstr, sizeof(addrstr), portstr, sizeof(portstr),</span><br><span class="line">                        NI_NUMERICHOST | NI_NUMERICSERV);</span><br><span class="line"></span><br><span class="line">                netdEventListener-&gt;onConnectEvent(fwmark.netId, connectInfo.error,</span><br><span class="line">                        connectInfo.latencyMs,</span><br><span class="line">                        (ret &#x3D;&#x3D; 0) ? String16(addrstr) : String16(&quot;&quot;),</span><br><span class="line">                        (ret &#x3D;&#x3D; 0) ? strtoul(portstr, NULL, 10) : 0, client-&gt;getUid());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        case FwmarkCommand::SELECT_NETWORK: &#123;</span><br><span class="line">            fwmark.netId &#x3D; command.netId;</span><br><span class="line">            if (command.netId &#x3D;&#x3D; NETID_UNSET) &#123;</span><br><span class="line">                fwmark.explicitlySelected &#x3D; false;</span><br><span class="line">                fwmark.protectedFromVpn &#x3D; false;</span><br><span class="line">                permission &#x3D; PERMISSION_NONE;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (int ret &#x3D; mNetworkController-&gt;checkUserNetworkAccess(client-&gt;getUid(),</span><br><span class="line">                                                                         command.netId)) &#123;</span><br><span class="line">                    return ret;</span><br><span class="line">                &#125;</span><br><span class="line">                fwmark.explicitlySelected &#x3D; true;</span><br><span class="line">                fwmark.protectedFromVpn &#x3D; mNetworkController-&gt;canProtect(client-&gt;getUid());</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        case FwmarkCommand::PROTECT_FROM_VPN: &#123;</span><br><span class="line">            if (!mNetworkController-&gt;canProtect(client-&gt;getUid())) &#123;</span><br><span class="line">                return -EPERM;</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F; If a bypassable VPN&#39;s provider app calls connect() and then protect(), it will end up</span><br><span class="line">            &#x2F;&#x2F; with a socket that looks like that of a system proxy but is not (see comments for</span><br><span class="line">            &#x2F;&#x2F; ON_CONNECT above). So, reset the NetId.</span><br><span class="line">            &#x2F;&#x2F;</span><br><span class="line">            &#x2F;&#x2F; In any case, it&#39;s appropriate that if the socket has an implicit VPN NetId mark, the</span><br><span class="line">            &#x2F;&#x2F; PROTECT_FROM_VPN command should unset it.</span><br><span class="line">            if (!fwmark.explicitlySelected &amp;&amp; mNetworkController-&gt;isVirtualNetwork(fwmark.netId)) &#123;</span><br><span class="line">                fwmark.netId &#x3D; mNetworkController-&gt;getDefaultNetwork();</span><br><span class="line">            &#125;</span><br><span class="line">            fwmark.protectedFromVpn &#x3D; true;</span><br><span class="line">            permission &#x3D; static_cast&lt;Permission&gt;(permission | fwmark.permission);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        case FwmarkCommand::SELECT_FOR_USER: &#123;</span><br><span class="line">            if ((permission &amp; PERMISSION_SYSTEM) !&#x3D; PERMISSION_SYSTEM) &#123;</span><br><span class="line">                return -EPERM;</span><br><span class="line">            &#125;</span><br><span class="line">            fwmark.netId &#x3D; mNetworkController-&gt;getNetworkForUser(command.uid);</span><br><span class="line">            fwmark.protectedFromVpn &#x3D; true;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        default: &#123;</span><br><span class="line">            &#x2F;&#x2F; unknown command</span><br><span class="line">            return -EPROTO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fwmark.permission &#x3D; permission;</span><br><span class="line"></span><br><span class="line">    if (setsockopt(*socketFd, SOL_SOCKET, SO_MARK, &amp;fwmark.intValue,</span><br><span class="line">                   sizeof(fwmark.intValue)) &#x3D;&#x3D; -1) &#123;</span><br><span class="line">        return -errno;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="输入法"><a href="#输入法" class="headerlink" title="输入法"></a>输入法</h1><p>AndroidManifest.xml </p>
<p>这里面指定的activity是主页上点击的，和设置里面点击的不一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"> Copyright (C) 2008-2012  OMRON SOFTWARE Co., Ltd.</span><br><span class="line"></span><br><span class="line"> Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> you may not use this file except in compliance with the License.</span><br><span class="line"> You may obtain a copy of the License at</span><br><span class="line"></span><br><span class="line">      http:&#x2F;&#x2F;www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"></span><br><span class="line"> Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> See the License for the specific language governing permissions and</span><br><span class="line"> limitations under the License.</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;manifest xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;apk&#x2F;res&#x2F;android&quot;</span><br><span class="line">          package&#x3D;&quot;my.com.cn.myime&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;original-package android:name&#x3D;&quot;my.com.cn.myime&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;uses-sdk android:minSdkVersion&#x3D;&quot;19&quot; &#x2F;&gt;</span><br><span class="line">    &lt;uses-permission xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;apk&#x2F;res&#x2F;android&quot; android:name&#x3D;&quot;android.permission.VIBRATE&quot;&#x2F;&gt;</span><br><span class="line">    &lt;uses-permission android:name&#x3D;&quot;android.permission.INTERNET&quot;&gt;&lt;&#x2F;uses-permission&gt;</span><br><span class="line">        &lt;uses-permission android:name&#x3D;&quot;android.permission.WRITE_SECURE_SETTINGS&quot; &#x2F;&gt;</span><br><span class="line">    &lt;application android:label&#x3D;&quot;我的输入法&quot;</span><br><span class="line">                android:icon&#x3D;&quot;@drawable&#x2F;ic_launcher&quot;</span><br><span class="line">        &gt;</span><br><span class="line"></span><br><span class="line">        &lt;service android:name&#x3D;&quot;MyIME&quot; </span><br><span class="line">                                android:label&#x3D;&quot;我的输入法&quot;</span><br><span class="line">                                android:permission&#x3D;&quot;android.permission.BIND_INPUT_METHOD&quot;</span><br><span class="line">                 &gt;</span><br><span class="line">            &lt;intent-filter&gt;</span><br><span class="line">                &lt;action android:name&#x3D;&quot;android.view.InputMethod&quot; &#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;intent-filter&gt;</span><br><span class="line">            &lt;meta-data android:name&#x3D;&quot;android.view.im&quot; android:resource&#x3D;&quot;@xml&#x2F;method&quot; &#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;service&gt;</span><br><span class="line">                &lt;activity android:name&#x3D;&quot;MainActivity&quot;&gt;</span><br><span class="line">            &lt;intent-filter&gt;</span><br><span class="line">                &lt;action android:name&#x3D;&quot;android.intent.action.MAIN&quot; &#x2F;&gt;</span><br><span class="line">                &lt;category android:name&#x3D;&quot;android.intent.category.LAUNCHER&quot; &#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;intent-filter&gt;</span><br><span class="line">        &lt;&#x2F;activity&gt;</span><br><span class="line">    &lt;&#x2F;application&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;manifest&gt; </span><br></pre></td></tr></table></figure>

<p>res/xml/method.xml</p>
<p>这个里面主要settingsActivity是指定在设置界面内点击输入法的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;                                                                                                                 </span><br><span class="line">&lt;!--</span><br><span class="line"> Copyright (C) 2008-2012  OMRON SOFTWARE Co., Ltd.</span><br><span class="line"></span><br><span class="line"> Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> you may not use this file except in compliance with the License.</span><br><span class="line"> You may obtain a copy of the License at</span><br><span class="line"></span><br><span class="line">      http:&#x2F;&#x2F;www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"> </span><br><span class="line">  Unless required by applicable law or agreed to in writing, software</span><br><span class="line">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">  See the License for the specific language governing permissions and</span><br><span class="line">  limitations under the License.</span><br><span class="line"> --&gt;</span><br><span class="line">&lt;!-- The attributes in this XML file provide configuration information --&gt;</span><br><span class="line">&lt;!-- for the Search Manager. --&gt;</span><br><span class="line"></span><br><span class="line">&lt;input-method xmlns:android&#x3D;&quot;http:&#x2F;&#x2F;schemas.android.com&#x2F;apk&#x2F;res&#x2F;android&quot;</span><br><span class="line">                          android:settingsActivity&#x3D;&quot;my.com.cn.myime.MainActivity&quot;</span><br><span class="line">              &gt;</span><br><span class="line">&lt;&#x2F;input-method&gt;</span><br></pre></td></tr></table></figure>

<p>输入法如果不实现InputView在某些情况下将会有一些问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override public View onCreateInputView() &#123;</span><br><span class="line">     </span><br><span class="line">        return this.getLayoutInflater().inflate(R.layout.keyboard_default_main, null);</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/22/Android/" data-id="ckpbyid1s00009l6h3csc4bxy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/05/31/exsi/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          exsi
        
      </div>
    </a>
  
  
    <a href="/2021/03/24/coding/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">coding 代码托管和动态网站</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Aria2/" rel="tag">Aria2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ESP32/" rel="tag">ESP32</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ESP8266/" rel="tag">ESP8266</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Erlang/" rel="tag">Erlang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Home-Assistant/" rel="tag">Home Assistant</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQTT/" rel="tag">MQTT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac-mini/" rel="tag">Mac mini</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MicroPython/" rel="tag">MicroPython</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NAS/" rel="tag">NAS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SeLinux/" rel="tag">SeLinux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VSCode/" rel="tag">VSCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VirtualBox/" rel="tag">VirtualBox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebDav/" rel="tag">WebDav</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/easy-rsa/" rel="tag">easy-rsa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mcpe/" rel="tag">mcpe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sshd/" rel="tag">sshd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uiautomator/" rel="tag">uiautomator</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Aria2/" style="font-size: 10px;">Aria2</a> <a href="/tags/ESP32/" style="font-size: 10px;">ESP32</a> <a href="/tags/ESP8266/" style="font-size: 10px;">ESP8266</a> <a href="/tags/Erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/Home-Assistant/" style="font-size: 10px;">Home Assistant</a> <a href="/tags/MQTT/" style="font-size: 10px;">MQTT</a> <a href="/tags/Mac-mini/" style="font-size: 10px;">Mac mini</a> <a href="/tags/MicroPython/" style="font-size: 10px;">MicroPython</a> <a href="/tags/NAS/" style="font-size: 10px;">NAS</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/SeLinux/" style="font-size: 10px;">SeLinux</a> <a href="/tags/VSCode/" style="font-size: 10px;">VSCode</a> <a href="/tags/VirtualBox/" style="font-size: 10px;">VirtualBox</a> <a href="/tags/WebDav/" style="font-size: 10px;">WebDav</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/easy-rsa/" style="font-size: 10px;">easy-rsa</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/mcpe/" style="font-size: 10px;">mcpe</a> <a href="/tags/sshd/" style="font-size: 10px;">sshd</a> <a href="/tags/uiautomator/" style="font-size: 10px;">uiautomator</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/06/04/ssl/">ssl证书</a>
          </li>
        
          <li>
            <a href="/2021/05/31/exsi/">exsi</a>
          </li>
        
          <li>
            <a href="/2021/04/22/Android/">Android 一些记录</a>
          </li>
        
          <li>
            <a href="/2021/03/24/coding/">coding 代码托管和动态网站</a>
          </li>
        
          <li>
            <a href="/2021/03/17/qinniu/">七牛云，百度网盘</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 王承志<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a><br>
      <a href="https://beian.miit.gov.cn" target="_blank"> 浙ICP备15023158号 </a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>